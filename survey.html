<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
        <title>Survey</title>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
        <script>$.fn.slider = null</script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="js/tagmanager.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tagmanager/3.0.2/tagmanager.min.css" integrity="sha256-bOEaK4HVga5gZsjsEWTe2m8GUDvK+mHcoj4N9W56uBo=" crossorigin="anonymous" />
        <script src="js/multi-switch.js"></script>
        <script src="js/progressbar.min.js"></script>
        <link rel="stylesheet" href="css/multi-switch.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/bootstrap-slider.min.js" integrity="sha256-oj52qvIP5c7N6lZZoh9z3OYacAIOjsROAcZBHUaJMyw=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.6.2/css/bootstrap-slider.min.css" integrity="sha256-G3IAYJYIQvZgPksNQDbjvxd/Ca1SfCDFwu2s2lt0oGo=" crossorigin="anonymous" />

        <link rel="stylesheet" href="css/survey.css">
    </head>

    <body>
        <div id="prog-bar"></div>

        <div id="p0" class="page central">
            <form id="nickname">
                <div class="form-group">
                    <label class="demo-q" for="other-name">If you have name(s) other than your legal name (like a nickname) that people call you by, please write them here.</label>
                    <input id="other-name" class="form-control" placeholder="Enter name(s)">
                </div>
            </form>
        </div>

        <!-- roster -->
        <div id="p1" class="page central">
            <div class="form-group">
                <span class="form-text">For the following questions, please consider your social interactions since you arrived at UCLA. 
                    Please enter people's first name and last name (for example, Daniel Kim), and click "Add" or hit Enter after each person.</span>
                <small id="duplicate" class="form-text text-muted">If you know different people with the same name, please add a descriptive term that's meaningful to yourself, 
                    so that you can disambiguate them later (for example, Daniel Kim artist, Daniel Kim new-york, Daniel Kim chess-club, etc.).</small>
                <div class="question-text roster-text"></div>
                <p id="dorm-name-instr" class="sm-instr">
                    i) Please name the people who fit the above criteria for you from <strong>your wing of Hedrick Hall</strong>
                </p>
                <div class="row">
                    <div class="col">
                        <input type="text" id="dorm-names" class="tm-input form-control" placeholder="Enter one name at a time"/>
                    </div>
                    <div class="col-auto">
                        <button id="btn-dorm-add" class="btn btn-success">Add</button>
                    </div>
                </div>
                <div id="dorm-names-container"></div>
            </div>
            <div class="form-group">
                <p id="outsider-name-instr" class="sm-instr">
                    ii) Please add anyone else (including other people at UCLA or people outside of UCLA) who fits the above criteria for you
                </p>
                <small id="instr-public" class="text-muted">Public figures don't count</small>
                <div class="row">
                    <div class="col">
                        <input type="text" id="outsider-names" class="tm-input form-control" placeholder="Enter one name at a time"/>
                    </div>
                    <div class="col-auto">
                        <button id="btn-outsider-add" class="btn btn-success">Add</button>
                    </div>
                </div>
                <div id="outsider-names-container"></div>
            </div>
        </div>

        <!-- tie strength -->
        <div id="p2" class="page central">
            <div class="question-text"></div>
            <div id="p2-questions"></div>
        </div>

        <!-- likert -->
        <div id="p3" class="page central">
            <div class="question-text"></div>
            <div id="p3-questions"></div>
        </div>

        <!-- demographic -->
        <div id="p4" class="page central">
            <form id="demographic">
                <div class="form-group">
                    <label class="demo-q" for="age">What is your age?</label>
                    <input id="age" class="form-control" placeholder="Enter age" type="number" required>
                </div>
                <div class="form-group">
                    <label class="demo-q" for="year">What year are you?</label> <br>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" value="1" required>
                            <label class="form-check-label">Freshman</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" value="2">
                            <label class="form-check-label">Sophomore</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" value="3">
                            <label class="form-check-label">Junior</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" value="4">
                            <label class="form-check-label">Senior</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="year" value="other" id="other-year-check">
                            <label class="form-check-label">Other</label>
                            <input id="other-year" class="form-control" placeholder="Please specify" style="margin: 0 5px;">
                        </div>
                </div>
                <div class="form-group">
                    <label class="demo-q" for="gender">What gender do you identify with?</label> <br>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" value="male" required>
                        <label class="form-check-label">Male</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" value="female">
                        <label class="form-check-label">Female</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" value="other">
                        <label class="form-check-label">Other</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" value="no_answer">
                        <label class="form-check-label">Prefer not to answer</label>
                    </div>
                </div>
                <div class="form-group" id="race-group">
                    <label class="demo-q" for="race">What race(s) do you consider yourself to be?</label>
                    <div class="form-check">
                        <input id="race" class="form-check-input" type="checkbox" name="race" value="white">
                        <label class="form-check-label">White/Caucasian</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="race" value="hispanic">
                        <label class="form-check-label">Hispanic/Latino</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="race" value="black">
                        <label class="form-check-label">Black/African American</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="race" value="asian">
                        <label class="form-check-label">Asian</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="race" value="native">
                        <label class="form-check-label">American Indian or Alaskan Native</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="race" value="other" id="other-race-check">
                        <label class="form-check-label">Other</label>
                        <input id="other-race" class="form-control" placeholder="Please specify" style="margin: 0 5px;">
                    </div>
                </div>
                <div class="form-group">
                    <label class="demo-q" for="major">What is (or will likely be) your major?</label>
                    <input id="major" class="form-control" placeholder="Enter major" required>
                </div>
                <div class="form-group">
                    <label class="demo-q" for="zipcode">What was your home zipcode before moving to UCLA? If it's outside the US, please also indicate the country you moved here from.</label>
                    <div id="international-zip" class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="international-check">
                        <label class="custom-control-label" for="international-check">Check this box if you moved from outside the US</label>
                    </div>
                    <div class="row">
                        <div class="col-6"><input id="zipcode" class="form-control" placeholder="Zipcode/postal code" required></div>
                        <div class="col-6"><input id="country" class="form-control" placeholder="Your country"></div>
                    </div>
                </div>
            </form>
        </div>

        <!-- payment -->
        <div id="p5" class="page central">
            <div class="question-text"></div>
            <p>Our default is to pay you in one lump sum. For example, if you did this survey ($20), both fMRI sessions (2 x $50), and got the $5 bonus (if >80% of people in your wing of Hedrick do this survey), you would get a payment of of $125. Providng lump sum payment is our default because people have preferred this in the past and because it facilitates giving out the bonus payments. Is this OK with you or do you prefer to be paid in smaller increments?</p>
            <form id="lumpsum-form" class="pay-form">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="lumpsum" value="yes" required>
                    <label class="form-check-label">Yes, this is OK with me.</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="lumpsum" value="no">
                    <label class="form-check-label">No, I prefer to be paid in smaller increments (if so, please email csnl@ucla.edu to arrange this).</label>
                </div>
            </form>
            <br><br>
            <p>We can pay you in cash or gift cards. Which do you prefer?</p>
            <form id="payment-form" class="pay-form">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment" value="cash" required>
                    <label class="form-check-label">Cash</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment" value="amazon">
                    <label class="form-check-label">Amazon gift card</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment" value="target">
                    <label class="form-check-label">Target gift card</label>
                </div>
            </form>
            <br><br>
            <p>If you also do the fMRI sessions, we can also provide you with a 3D print of your brain. Are you interested in this?</p>
            <form id="fmri-form" class="pay-form">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="fmri" value="yes" required>
                    <label class="form-check-label">Yes</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="fmri" value="no">
                    <label class="form-check-label">No</label>
                </div>
            </form>
        </div>

        <div id="no-prev">You won't be able to come back and change any of your answers after proceeding to the next question</div>

        <div id="invalid1" class="invalid">You didn't nominate anyone for this question. Is that response accurate?</div>
        <div class="row central">
            <div class="col-4"><button id="btn-prev" class="btn btn-secondary">Previous</button></div>
            <div class="col-4" align="center"><button id="btn-next" class="btn btn-primary">Next</button></div>
            <div class="col-4"></div>
        </div>
        <div id="invalid2" class="invalid">Please answer the required questions before proceeding</div>


        <!-- Firebase -->
        <script type="module">
            // initialize user response id
            var parameters = window.location.search.substring(1).split(/[&=]/);
            var user_id = parameters[1];
            var timestamp = parameters[3];
            var tally = parameters[7];
            if (!user_id || user_id.length != 64 || !timestamp || timestamp.length != 13 || !tally || tally.length != 2) {
                alert('This URL is invalid. Please contact the experimenters.');
                $('body').hide();
            }
            if (parseInt(timestamp) == 0) {
                timestamp = Date.now().toString();
            }

            var DB_TYPE = 'prod_';  // 'test_' or 'prod_'

            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
            import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js';
            import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js';

            const firebaseConfig = {
                apiKey: "AIzaSyAmOb9FOQh-gSwgNknNBIU9kCbtMDlFyEM",
                authDomain: "dorm---questionnaire.firebaseapp.com",
                projectId: "dorm---questionnaire",
                storageBucket: "dorm---questionnaire.appspot.com",
                messagingSenderId: "7204112419",
                appId: "1:7204112419:web:ebe91abba04302ee490996",
                measurementId: "G-X1SQS73M77"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // sign in
            // signInWithEmailAndPassword(user.email, user.pw).catch(function(error) {
            signInAnonymously(auth).catch(function(error) {
                const errorCode = error.code;
                const errorMessage = error.message;

                alert('Failed to access database. Please check your internet connection and try again.\n' +
                    'If it doesn\'t work, please contact the experimenters.\n' + 
                    'Error: ' + errorCode + '\n' + errorMessage);
                window.location.replace('login.html');  // refresh page
                console.log(error);
            });

            // +1 to # of completions
            async function increase_completion_count() {
                await updateDoc(doc(db, DB_TYPE + 'count', 'count'), {
                    [tally]: increment(1)
                });
            }

            // retrieve and load previous user progress
            async function get_user_progress(proc_func) {
                $('#btn-next').addClass('disabled');
                var docSnap = null;
                try {
                    docSnap = await getDoc(doc(db, DB_TYPE + 'data', user_id));
                } catch (e) {
                    alert('Failed to load your data. Please check your internet connection and try again.\n' +
                        'If this message shows up multiple times, please contact the experimenters.\n' + e);
                    location.reload();  // refresh page
                    console.log(e);
                }
                if (docSnap && docSnap.exists() && docSnap.data() && ('progress' in docSnap.data())) {
                    console.log('data', docSnap.data());
                    proc_func(docSnap.data());
                } else {
                    console.log('No existing progress.');
                    $('#p0').show();
                    $('#btn-next').removeClass('disabled');
                }
                if (docSnap.data() && !('participant_id' in docSnap.data())) {
                    let pid = user_id.slice(0, 3) + timestamp.toString().slice(3, 7);  // ID for other tasks
                    let ref = doc(db, DB_TYPE + 'data', user_id);
                    await setDoc(ref, {
                        participant_id: pid
                    }, { merge: true });
                }
            }

            // send data to firebase
            async function save2firebase(data, page_i, question_i, progress=true, end=false) {
                try {
                    let db_key = page_i + '.' + question_i;
                    let ref = doc(db, DB_TYPE + 'data', user_id);
                    let save_data = { [timestamp]: {[db_key]: data}};
                    if (progress) {
                        save_data.progress = db_key;
                    }
                    await setDoc(ref, save_data, { merge: true });
                    if (end) {
                        let end_time = Date.now();
                        await setDoc(ref, {
                            end_time: end_time
                        }, { merge: true });
                        await increase_completion_count();
                        // show end page
                        window.hookWindow = false;
                        window.location.replace('progress.html?l=' + parameters[5] + '&t=' + parameters[7]);
                    }
                } catch (e) {
                    alert('Failed to save your data. Please check your internet connection and try again.\n' +
                        'If this message shows up multiple times, please contact the experimenters.\n' + e);
                    location.reload();  // refresh page
                    console.log(e);
                }
            }
            // global functions
            window.get_user_progress = get_user_progress;
            window.save2firebase = save2firebase;
        </script>

        <!-- other JavaScript -->
        <script type="text/javascript" src="js/questions.js"></script>
        <script type="text/javascript" src="js/levenshtein.js"></script>
        <script type="text/javascript" src="js/survey.js"></script>
    </body>
</html>
